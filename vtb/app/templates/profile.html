{% extends 'base.html' %}

{% block title %}Профиль{% endblock %}

{% block content %}
<style>

    .card {
        border: 2px solid #ffffff; /* Белая рамка вокруг карточки */
        border-radius: 10px; /* Закругленные углы */
        overflow: hidden; /* Скрыть переполнение */
    }

    .card-title {
        font-size: 1.5rem; /* Размер шрифта заголовка */
        font-weight: bold; /* Жирный шрифт */
        color: #ffffff; /* Цвет текста заголовка */
        text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5); /* Тень для текста */
        margin-bottom: 20px; /* Отступ снизу */
        animation: fadeIn 1s; /* Анимация появления заголовка */
    }

    @keyframes fadeIn {
        from { opacity: 0; }
        to { opacity: 1; }
    }

    .btn {
        transition: background-color 0.3s, transform 0.3s; /* Плавный переход для кнопок */
    }

    .btn:hover {
        background-color: #ffffff; /* Цвет фона при наведении */
        color: red;
        transform: scale(1.05); /* Увеличение кнопки при наведении */
    }
    .modal-open {
        overflow: hidden;
    }
    .alert {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #757171;
        color: #fff;
        padding: 10px 20px;
        border-radius: 5px;
        font-size: 18px;
        opacity: 0;
        transform: translateY(-20px);
        transition: opacity 0.5s ease, transform 0.5s ease;
        z-index: 1000;
    }

    .alert.show {
        opacity: 1;
        transform: translateY(0);
    }
    /* Скрываем модальное окно по умолчанию */
.modal {
    display: none; /* Модал скрыт */
    opacity: 0; /* Прозрачность 0 */
    transition: opacity 0.3s ease; /* Плавный переход */
}

/* Показываем модальное окно */
.modal.show {
    display: block; /* Модал видим */
    opacity: 1; /* Полная непрозрачность */
}

/* Затемнение фона */
.modal-dialog {
    transform: scale(0.9); /* Уменьшенная модал по умолчанию */
    transition: transform 0.3s ease; /* Плавный зум */
}

.modal.show .modal-dialog {
    transform: scale(1); /* Нормальный размер при отображении */
}

</style>

<div class="row justify-content-center">
    <div class="col-md-6">
        <div class="card bg-secondary text-light">
            <div class="card-body">
                <h4 class="card-title text-center mb-4">Профиль</h4>
                <p><strong>Почта:</strong> {{ request.user.email }}</p>
                <p>
                    <strong>Секретный ключ:</strong>
                    <span id="secretKey" class="text-monospace">●●●●●</span>
                <p>
                    <button id="toggleButton" class="btn btn-sm btn-outline-light" onclick="toggleVisibility()"
                            style="margin-left: 10px;" data-bs-placement="top" title="Показать/скрыть код">
                        <i id="toggleIcon" class="bi bi-eye"></i>
                    </button>
                    <button id="copyButton" class="btn btn-sm btn-outline-light" onclick="copyToClipboard()"
                            style="margin-left: 10px;" data-bs-placement="top" title="Скопировать в буфер обмена">
                        <i class="bi bi-clipboard"></i>
                    </button>
                    <button id="regenerateButton" class="btn btn-icon btn-sm btn-outline-light"
                            style="margin-left: 10px;" data-bs-toggle="tooltip" data-bs-placement="top"
                            title="Изменить код">
                        <i class="bi bi-arrow-repeat"></i>
                    </button>
                <div id="alertContainer"></div>
                </p>
            </div>
        </div>
    </div>
</div>

<div id="alert" class="alert alert-success position-fixed"
     style="top: 20px; right: 20px; display: none; opacity: 0; transform: translateY(-20px); transition: opacity 0.5s, transform 0.5s;"
     role="alert">
    Секретный ключ скопирован в буфер обмена!
</div>

<!-- Модальное окно -->
<div class="modal" id="customModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" style="color: black;">Подтверждение</h5>
                <button type="button" class="close" id="customCloseButton">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p style="color: black;">Вы уверены, что хотите изменить секретный ключ? <br> Данное действие отвяжет
                    все текущие способы 2FA.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="closeModal">Отмена</button>
                <button type="button" class="btn btn-danger" id="confirmRegenerate">Подтвердить</button>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const modal = document.getElementById('customModal');
        const closeModalButtons = [
            document.getElementById('closeModal'),
            document.getElementById('customCloseButton')
        ];
        const regenerateButton = document.getElementById('regenerateButton');
        const confirmButton = document.getElementById('confirmRegenerate');
        const openModal = () => {
            modal.style.display = 'block';
            modal.classList.add('show');
            document.body.classList.add('modal-open');
        };
        const closeModal = () => {
            modal.style.display = 'none';
            modal.classList.remove('show');
            document.body.classList.remove('modal-open');
        };
        regenerateButton.addEventListener('click', openModal);
        closeModalButtons.forEach(button => button.addEventListener('click', closeModal));
        confirmButton.addEventListener('click', () => {
            regenerateKey();
            closeModal();
        });
    });

    const regenerateKey = () => {
        fetch('/regenerate-key/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                user_id: '{{ request.user.id }}'
            })
        })
        .then(response => {
            if (response.ok) {
                return response.json();
            }
            throw new Error('Ошибка при генерации ключа');
        })
        .then(data => {
            document.getElementById('secretKey').textContent = data.new_secret_key;
            showAlert('Секретный ключ успешно обновлён!');
        })
        .catch(error => {
            console.error('Ошибка:', error);
            showAlert('Не удалось обновить секретный ключ.');
        });
    };

    const showAlert = (message) => {
        const alertBox = document.getElementById('alert');
        alertBox.textContent = message;

        alertBox.style.display = 'block';
        alertBox.style.opacity = '1';
        alertBox.style.transform = 'translateY(0)';

        setTimeout(() => {
            alertBox.style.opacity = '0';
            alertBox.style.transform = 'translateY(-20px)';
            setTimeout(() => {
                alertBox.style.display = 'none';
            }, 700);
        }, 3000);
    };
    const user_info = "{{user_info}}"; // Здесь замените значение на нужный ключ

    // Функция для показа/скрытия ключа
    function toggleVisibility() {
        const secretKeyElement = document.getElementById("secretKey");
        const toggleIcon = document.getElementById("toggleIcon");

        if (secretKeyElement.textContent === "●●●●●") {
            secretKeyElement.textContent = user_info;
            toggleIcon.classList.remove("bi-eye");
            toggleIcon.classList.add("bi-eye-slash");
            showCustomAlert("Ключ показан");
        } else {
            secretKeyElement.textContent = "●●●●●";
            toggleIcon.classList.remove("bi-eye-slash");
            toggleIcon.classList.add("bi-eye");
            showCustomAlert("Ключ скрыт");
        }
    }

    // Функция для копирования ключа в буфер обмена
    function copyToClipboard() {
        const temporaryInput = document.createElement("input");
        temporaryInput.value = user_info;
        document.body.appendChild(temporaryInput);
        temporaryInput.select();
        temporaryInput.setSelectionRange(0, 99999); // Для мобильных устройств
        document.execCommand("copy");
        document.body.removeChild(temporaryInput);

        showCustomAlert("Ключ скопирован в буфер обмена!");
    }

    // Функция для показа уведомления
    function showCustomAlert(message) {
        const alertContainer = document.getElementById("alertContainer");

        // Создаем элемент уведомления
        const alert = document.createElement("div");
        alert.className = "alert";
        alert.textContent = message;

        // Добавляем уведомление в контейнер
        alertContainer.appendChild(alert);

        // Плавно показываем уведомление
        setTimeout(() => {
            alert.classList.add("show");
        }, 100);

        // Убираем уведомление через 3 секунды
        setTimeout(() => {
            alert.classList.remove("show");
            setTimeout(() => alert.remove(), 500); // Удаляем из DOM
        }, 3000);
    }
</script>

{% endblock %}